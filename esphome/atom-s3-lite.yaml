# Version 1.0
# - Improved internal LED behavior
#   - LED disable state is now persistent across reboots
#   - LED is now event-driven for faster response times
#
# Improvements todo:
# - Improved brightness control using the M5Stack button
# - Clear distinction between normal operation brightness and alert brightness

esphome:
  name: ${name}
  # friendly_name: ${friendly_name}  ### temporarely uncommented because of sensor naming wrong for nodered flow gitcode bob
  min_version: 2026.1.0     ## config updated to the latest ESPHome requerments.
  name_add_mac_suffix: false

esp32:
  board: esp32-s3-devkitc-1  ## M5stack Atom S3 lite  
  flash_size: 8MB
  variant: esp32s3
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    version: recommended
    ## Custom sdkconfig options
    sdkconfig_options:
      COMPILER_OPTIMIZATION_SIZE: y
      CONFIG_BT_ENABLED: n

psram:
  mode: octal
  speed: 80MHz

# this is only for changing the status LED. The WiFi configuration is in de main yaml.
wifi:
  on_connect:
    then:
      - script.execute: update_status_led
  on_disconnect:
    then:
      - script.execute: update_status_led

# this is only for changing the status LED. The Api configuration is in de main yaml.
api:
  on_client_connected:
    then:
      - script.execute: update_status_led
  on_client_disconnected:
    then:
      - script.execute: update_status_led

switch:
  - platform: template
    name: "Disable Light"
    id: disable_light
    icon: mdi:toggle-switch
    entity_category: diagnostic
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    on_turn_on:
      - script.execute: update_status_led
    on_turn_off:
      - script.execute: update_status_led
    web_server:
      sorting_group_id: ESP

# Uart logging on/off switch
  - platform: template
    name: UART Logging
    id: uart_debug_switch
    icon: mdi:text
    restore_mode: ALWAYS_OFF
    optimistic: true
    turn_on_action:
      - logger.set_level: VERBOSE
    turn_off_action:
      - logger.set_level: ERROR
    entity_category: diagnostic
    on_turn_on:
      - script.execute: update_status_led
    on_turn_off:
      - script.execute: update_status_led
    web_server:
      sorting_group_id: ESP
      sorting_weight: 20

button:
  - platform: restart
    name: ESP Restart
    entity_category: diagnostic
    web_server:
      sorting_group_id: ESP
    
  - platform: safe_mode
    name: "ESP Safe Mode Boot"
    entity_category: diagnostic
    web_server:
      sorting_group_id: ESP

text_sensor:
  - platform: wifi_info
    ip_address:
      name: ESP IP Address
      icon: mdi:ip
      disabled_by_default: True
      web_server:
        sorting_group_id: ESP

    ssid:
      name: ESP SSID
      icon: mdi:wifi
      disabled_by_default: True
      web_server:
        sorting_group_id: ESP

    dns_address:
      name: ESP DNS
      icon: mdi:help-network-outline
      disabled_by_default: True
      web_server:
        sorting_group_id: ESP

    bssid:
      name: ESP Connected BSSID
      icon: mdi:expansion-card
      disabled_by_default: True
      web_server:
        sorting_group_id: ESP

    mac_address:
      name: ESP Mac Address
      icon: mdi:expansion-card-variant
      disabled_by_default: True
      web_server:
        sorting_group_id: ESP

  - platform: version
    name: ESP Version
    hide_timestamp: true
    disabled_by_default: false
    icon: mdi:new-box
    entity_category: diagnostic
    web_server:
      sorting_group_id: ESP
      sorting_weight: 2

# Binaire sensoren
binary_sensor:
## Push button on top of Atom S3 lite
## Short push = led On or Off
## Long push = led brightness changes
  - platform: gpio
    pin:
      number: GPIO41
      inverted: true
      mode: INPUT_PULLUP
    name: "Brightness Button"
    id: brightness_button
    internal: true
    icon: mdi:brightness-6


    on_click: 
      then:
        - logger.log: "Korte druk - toggle LED"
        - switch.toggle: disable_light
                
    on_press:
      - while:
          condition:
            binary_sensor.is_on: brightness_button

          then:
            - light.dim_relative:
                id: status_led
                relative_brightness: 5%
                transition_length: 0.1s
                brightness_limits:
                    min_brightness: 25%
                    max_brightness: 100%
            - delay: 0.1s
  
## Sensoren
sensor:
  - name: "Atom temperature"
    id: atom_temperature
    icon: mdi:thermometer
    platform: internal_temperature
    update_interval: 30s
    entity_category: diagnostic
    web_server:
      sorting_group_id: ESP
      sorting_weight: 14

  - platform: uptime   # Internal use
    id: deviceuptime

  - platform: template  # uptime sensor. Only readable in Home Assisant
    id: device_uptime_timestamp
    name: "Online"
    device_class: "timestamp"
    accuracy_decimals: 0
    update_interval: never
    icon: 'mdi:clock-start'
    entity_category: diagnostic
    lambda: |-
      static float timestamp = (
        id(homeassistant_time).utcnow().timestamp - id(deviceuptime).state
      );
      return timestamp;

###############################################################################
## STATUS LED
###############################################################################
## Simple status led for Atom s3 (lite)
## G35=RGB WS2812C-2020
light:
  - name: "Status led"
    id: status_led
    icon: mdi:lightbulb
    platform: esp32_rmt_led_strip
    disabled_by_default: True # Could be anabled in Home Assistant.
    #internal: true # Hides from Home Assistant
    rgb_order: GRB
    pin: 35
    num_leds: 4
    chipset: ws2812
#    rmt_channel: 0 #only on platform: arduino
    restore_mode: ALWAYS_OFF
    entity_category: diagnostic
    effects:
      - pulse:
          name: slow_pulse
          transition_length: 250ms
          update_interval: 500ms
          min_brightness: 10%
          max_brightness: 50%
      - pulse:
          name: fast_pulse
          transition_length: 100ms
          update_interval: 100ms
          min_brightness: 25%
          max_brightness: 75%
    web_server:
      sorting_group_id: ESP
      sorting_weight: 13

interval:
  - interval: 5s
    then:
      - script.execute: update_status_led

# ðŸŸ¢ Green on => wifi connected- api connected/ Green blinking => wifi connected - api disconnected
# ðŸ”´ Red => wifi disconnected
# ðŸ”µ Blue => AP mode
# ðŸŸ£ Purple fast pulse => UART logging on. 

script:
  - id: update_status_led
    mode: restart
    then:
      if:
        condition:
          lambda: 'return id(id_captive_portal).is_active();'
        then:
          - light.turn_on:
              id: status_led
              brightness: 100%
              red: 0
              green: 0
              blue: 100%
        else:
          if:
            condition:
              not:
                wifi.connected:
            then:
              - light.turn_on:
                  id: status_led
                  brightness: 100%
                  red: 100%
                  green: 0
                  blue: 0
            else:
              if:
                condition:
                  not:
                    api.connected:
                then:
                  - light.turn_on:
                      id: status_led
                      brightness: 100%
                      red: 0
                      green: 100%
                      blue: 0
                      effect: slow_pulse
                else:
                  if:
                    condition:
                      switch.is_on: uart_debug_switch
                    then:
                      - light.turn_on:
                          id: status_led
                          brightness: 100%
                          red: 100%
                          green: 0
                          blue: 100%
                          effect: fast_pulse
                    else: 
                      if:
                        condition:
                          switch.is_on: disable_light
                        then:
                          - light.turn_off: status_led
                        else:
                          - light.turn_on:
                              id: status_led
                              red: 0
                              green: 100%
                              blue: 0
                              effect: None

