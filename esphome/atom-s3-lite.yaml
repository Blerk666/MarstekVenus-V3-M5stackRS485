globals:
  - id: led_disabled
    type: bool
    restore_value: yes
    initial_value: 'false'

switch:
  - platform: template
    name: "light Disabled"
    id: light_disabled
    icon: mdi:toggle-switch
    disabled_by_default: True
    entity_category: diagnostic
    lambda: |-
      return id(led_disabled);
    turn_on_action:
      - logger.log: "Manual switch ON â†’ led_disabled = true"
      - globals.set:
          id: led_disabled
          value: 'true'
    turn_off_action:
      - logger.log: "Manual switch OFF â†’ led_disabled = false"
      - globals.set:
          id: led_disabled
          value: 'false'
# Uart logging on/off switch
  - platform: template
    name: UART Logging
    id: uart_debug_switch
    icon: mdi:text
    restore_mode: ALWAYS_OFF
    optimistic: true
    turn_on_action:
      - logger.set_level: VERBOSE
    turn_off_action:
      - logger.set_level: ERROR
    entity_category: diagnostic
    web_server:
      sorting_group_id: ESP
      sorting_weight: 20

text_sensor:
  - platform: wifi_info
    ip_address:
      name: ESP IP
      icon: mdi:ip
      web_server:
        sorting_group_id: Diagnostic
        sorting_weight: 4
    ssid:
      name: ESP SSID
      icon: mdi:wifi
      web_server:
        sorting_group_id: ESP
        sorting_weight: 3

  - platform: version
    name: ESP Version
    hide_timestamp: true
    disabled_by_default: false
    icon: mdi:new-box
    entity_category: diagnostic
    web_server:
      sorting_group_id: ESP
      sorting_weight: 2

# Binaire sensoren
binary_sensor:
## Push button on top of Atom S3 lite
## Short push = led On or Off
## Long push = led brightness changes
  - platform: gpio
    pin:
      number: GPIO41
      inverted: true
      mode: INPUT_PULLUP
    name: "Brightness Button"
    id: brightness_button
    internal: true
    icon: mdi:brightness-6
    on_multi_click:
      - timing:
          - ON for at least 1s
        then:
          - logger.log: "Lange druk gedetecteerd - start helderheid aanpassen"
          - script.execute: adjust_brightness_loop

      - timing:
          - ON for at most 700ms
          - OFF for at least 50ms
        then:
          - logger.log: "Korte druk - toggle LED"  
          - if:
              condition:
                light.is_on:
                  id: status_led
              then:
                - light.turn_off:
                    id: status_led
                - globals.set:
                    id: led_disabled
                    value: 'true'
              else:
                - light.turn_on:
                    id: status_led
                - globals.set:
                    id: led_disabled
                    value: 'false'
    on_release:
      then:
        - script.stop: adjust_brightness_loop
    web_server:
      sorting_group_id: ESP
      sorting_weight: 15

## Sensoren
sensor:
  - name: "Atom temperature"
    id: atom_temperature
    icon: mdi:thermometer
    platform: internal_temperature
    update_interval: 30s
    entity_category: diagnostic
    web_server:
      sorting_group_id: ESP
      sorting_weight: 14

###############################################################################
## STATUS LED
###############################################################################
## Simple status led for Atom s3 (lite)
## G35=RGB WS2812C-2020
light:
  - name: "Status led"
    id: status_led
    icon: mdi:lightbulb
    platform: esp32_rmt_led_strip
    disabled_by_default: True # Could be anabled in Home Assistant.
    #internal: true # Hides from Home Assistant
    rgb_order: GRB
    pin: 35
    num_leds: 4
    chipset: ws2812
#    rmt_channel: 0 #only on platform: arduino
    restore_mode: ALWAYS_OFF
    entity_category: diagnostic
    effects:
      - pulse:
          name: slow_pulse
          transition_length: 250ms
          update_interval: 500ms
          min_brightness: 10%
          max_brightness: 50%
      - pulse:
          name: fast_pulse
          transition_length: 100ms
          update_interval: 100ms
          min_brightness: 25%
          max_brightness: 100%
    web_server:
      sorting_group_id: ESP
      sorting_weight: 13

# ðŸŸ¢ Green on => wifi connected- api connected/ Green blinking => wifi connected - api disconnected
# ðŸ”´ Red => wifi disconnected
# ðŸ”µ Blue => AP mode

interval:
  - interval: 10s
    then:
          if:
            condition:
              wifi.connected:
            then:
              if:
                condition:
                  api.connected:
                then:
                  if:
                    condition:
                      # Check if variable led_disabled is False
                      # Flase - Turn Status led on
                      # True - Turn Status led off
                      - lambda: return !id(led_disabled);
                    then:  
                      - light.turn_on:
                          id: status_led
                          red: 0
                          green: 100%
                          blue: 0
                          effect: None
                    else:
                      - light.turn_off:
                          id: status_led

                else:
                  - light.turn_on:
                      id: status_led
                      brightness: 100%
                      red: 0
                      green: 100%
                      blue: 0
                      effect: slow_pulse              
            else:
              if:
                condition:
                  - lambda: 'return id(id_captive_portal).is_active();'
                then:
                  - light.turn_on:
                      id: status_led
                      brightness: 100%
                      red: 0
                      green: 0
                      blue: 100%
                else:
                  - light.turn_on:
                      id: status_led
                      brightness: 100%
                      red: 100%
                      green: 0
                      blue: 0

## knop op de atom ingedrukt houden = veranderen brightness
script:
  - id: adjust_brightness_loop
    mode: restart
    then:
      - repeat:
          count: 1000
          then:
            - lambda: |-
                static float brightness = 0.0;
                brightness += 0.1;
                if (brightness > 1.0) brightness = 0.0;
                auto call = id(status_led).make_call();
                call.set_brightness(brightness);
                call.perform();
            - delay: 750ms
